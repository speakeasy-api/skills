# Overlay Creation Tests
# These tests verify that skills guide proper overlay creation
# Phase 1: Includes overlay validation, semantic checks, and CLI validation

tests:
  - name: fix-poor-naming-with-overlay
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/petstore-poor-naming.yaml
    task: |
      The OpenAPI spec has missing operationIds which will result in poor SDK method names.
      Create an overlay file that adds x-speakeasy-name-override and x-speakeasy-group extensions
      to improve the SDK naming. Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - x-speakeasy-name-override
      - x-speakeasy-group
    # Will run semantic validation for naming overlay structure

  - name: add-offset-pagination-to-products
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/paginated-api.yaml
    task: |
      The /products endpoint uses offset/limit pagination (offset and limit query params).
      The response has 'items' array and 'total' count. Create an overlay file that adds
      x-speakeasy-pagination extension so the SDK can auto-paginate through all products.
      Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - x-speakeasy-pagination
    # Semantic validation checks for type: offsetLimit, inputs, outputs

  - name: add-cursor-pagination-to-orders
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/paginated-api.yaml
    task: |
      The /orders endpoint uses cursor-based pagination. It takes a 'cursor' query param
      and returns 'next_cursor' in the response along with 'has_more' boolean.
      Create an overlay file that adds x-speakeasy-pagination extension for cursor-based iteration.
      Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - x-speakeasy-pagination
    # Semantic validation checks for type: cursor, nextCursor output

  - name: add-retry-configuration
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/petstore-minimal.yaml
    task: |
      Create an overlay file that adds x-speakeasy-retries configuration with exponential backoff
      for 5XX errors and 429 rate limits. Use sensible defaults for intervals.
      Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - x-speakeasy-retries
      - backoff
      - "5XX"
    # Semantic validation checks for strategy, backoff config, statusCodes

  - name: add-open-enums
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/petstore-minimal.yaml
    task: |
      Create an overlay file that makes all enums "open" by adding x-speakeasy-unknown-values
      so the SDK handles unknown enum values gracefully without breaking.
      Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - x-speakeasy-unknown-values
      - allow

  - name: add-server-url-override
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/petstore-minimal.yaml
    task: |
      Create an overlay file that adds both a production and staging server with appropriate descriptions.
      Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - servers
      - url
      - description

  - name: add-deprecation-notices
    skill: manage-openapi-overlays
    type: overlay
    spec_file: fixtures/petstore-minimal.yaml
    task: |
      Create an overlay file that marks certain operations as deprecated and adds x-speakeasy-deprecation-message
      with a migration notice. Write a new overlay file, do not edit the spec directly.
    expected_extensions:
      - deprecated
      - x-speakeasy-deprecation-message

  - name: openrouter-issue-1-type-improvements
    skill: manage-openapi-overlays
    type: overlay
    source:
      repository: https://github.com/OpenRouterTeam/go-sdk
      commit: c2c3c701312ed9c362b305af03718de51c03758d
      spec_path: .speakeasy/in.openapi.yaml
      issue:
        repo: OpenRouterTeam/go-sdk
        number: 1
    fixture_dir: fixtures/openrouter-go-sdk-issue-1
    max_turns: 30
    target: go
    task: |
      Solve GitHub issue #1 for the OpenRouter Go SDK.
      The issue is at issue.md

    expected_extensions:
      - "type: integer"
      - "format: date-time"

    scoring:
      required:
        - name: index_fixed
          description: ChatResponseChoice.index changed to integer
          target_contains: "ChatResponseChoice"
          has: "type: integer"
          points: 20
        - name: created_fixed
          description: ChatResponse.created has date-time format
          target_contains: "ChatResponse"
          has: "format: date-time"
          points: 20
        - name: completion_tokens_fixed
          description: completion_tokens changed to integer
          target_contains: "completion_tokens"
          has: "type: integer"
          points: 15
        - name: prompt_tokens_fixed
          description: prompt_tokens changed to integer
          target_contains: "prompt_tokens"
          has: "type: integer"
          points: 15
        - name: total_tokens_fixed
          description: total_tokens changed to integer
          target_contains: "total_tokens"
          has: "type: integer"
          points: 15

      bonus:
        - name: streaming_created_fixed
          description: Also fixed ChatStreamingResponseChunk.created
          target_contains: "ChatStreamingResponseChunk"
          has: "format: date-time"
          points: 5
        - name: nested_reasoning_tokens
          description: Fixed reasoning_tokens in details
          target_contains: "reasoning_tokens"
          has: "type: integer"
          points: 5
        - name: nested_cached_tokens
          description: Fixed cached_tokens in details
          target_contains: "cached_tokens"
          has: "type: integer"
          points: 5

      negative:
        - name: finish_reason_unchanged
          description: Did NOT modify finish_reason (constraint respected)
          target_not_contains: "finish_reason"
        - name: schema6_unchanged
          description: Did NOT modify __schema6 (constraint respected)
          target_not_contains: "__schema6"

    api_validation:
      enabled: true
      always_run: false
      env_var: OPENROUTER_API_KEY
      endpoint: https://openrouter.ai/api/v1/chat/completions
      request:
        model: "openai/gpt-4o-mini"
        messages:
          - role: user
            content: "Say hello"
      expected_types:
        "choices[0].index": integer
        "created": integer
        "usage.completion_tokens": integer
        "usage.prompt_tokens": integer
        "usage.total_tokens": integer
